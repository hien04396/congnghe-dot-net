@model OnlineShop.ViewModels.CartViewModel

@{
    ViewData["Title"] = "Cart";
}

<h2>Your Cart</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (!Model.Items.Any())
{
    <p>Your cart is empty.</p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Product</th>
            <th>Unit Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in Model.Items)
        {
            <tr class="@(item.IsOutOfStock ? "table-warning" : "")">
                <td>
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <img src="@item.ImageUrl" alt="@item.ProductName" style="height:40px;margin-right:8px;" />
                    }
                    @item.ProductName
                    @if (item.IsOutOfStock)
                    {
                        <div class="small text-danger">Out of stock</div>
                    }
                    @if (item.HasPromo)
                    {
                        <span class="badge bg-success small ms-2">-@item.PromoDiscount!.Value.ToString("C") OFF</span>
                    }
                </td>
                <td>
                    @if (item.HasPromo)
                    {
                        <div>
                            <span class="text-decoration-line-through text-muted small">@item.OriginalPrice.ToString("C")</span>
                            <span class="text-danger fw-bold d-block">@item.UnitPrice.ToString("C")</span>
                        </div>
                    }
                    else
                    {
                        <span>@item.UnitPrice.ToString("C")</span>
                    }
                </td>
                <td>
                    <form asp-action="Update" method="post" class="d-inline-flex">
                        <input type="hidden" name="productId" value="@item.ProductId" />
                        <input type="number" name="quantity" value="@item.Quantity" min="0"
                               class="form-control form-control-sm me-2"
                               style="width:90px" @(item.IsOutOfStock ? "disabled" : null) />
                        <button type="submit" class="btn btn-sm btn-outline-primary" @(item.IsOutOfStock ? "disabled" : null)>Update</button>
                    </form>
                </td>
                <td>@((item.UnitPrice * item.Quantity).ToString("C"))</td>
                <td class="text-end">
                    <form asp-action="Remove" method="post" class="d-inline">
                        <input type="hidden" name="productId" value="@item.ProductId" />
                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>

    <div class="d-flex justify-content-between">
        <div>
            <a asp-controller="Store" asp-action="Products" class="btn btn-outline-secondary">Continue shopping</a>
        </div>
        <div class="text-end">
            <h4>Total: @Model.Total.ToString("C")</h4>
            @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Customer"))
            {
                <form asp-action="Checkout" method="post">
                    <button type="submit" class="btn btn-success mt-2">Checkout</button>
                </form>
            }
            else
            {
                <p class="text-muted mt-2">You must <a asp-controller="Account" asp-action="Login">login</a> as customer to checkout.</p>
            }
        </div>
    </div>
}


